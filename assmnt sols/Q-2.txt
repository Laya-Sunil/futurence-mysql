
--- 2 Trips

SELECT Day, ROUND((Cancelled_requests/Total_requests),2)as Cancellation Rate
FROM
    (SELECT t.request_at as Day, count(*)Cancelled_requests 
    FROM Trips t INNER JOIN Users u 
    ON t.client_id=u.users_id OR t.client_id=u.driver_id
    AND u.banned = 'No' 
    WHERE t.status like 'cancelled%'
    GROUP BY t.request_at)a
INNER JOIN 
    (SELECT t.request_at as Day, count(*)as Total_requests
    FROM Trips t INNER JOIN Users u 
    ON t.client_id=u.users_id OR t.client_id=u.driver_id
    AND u.banned = 'No' 
    GROUP BY t.request_at)b
USING (Day)
where Day BETWEEN '2013-10-01' AND '2013-10-03'
ORDER BY Day;

-----------------------------------------------------------
SELECT Day, ROUND((Cancelled_requests/Total_requests),2)as `Cancellation Rate`
FROM
    (SELECT t.request_at as Day, sum(case 
                                    when t.status like 'cancelled%' then 1 
                                    else 0
                                 end) as Cancelled_requests 
    FROM Trips t INNER JOIN Users u 
    ON (t.client_id=u.users_id) 
    where t.client_id not in (select distinct users_id from Users where banned='Yes')
    and t.driver_id not in (select distinct users_id from Users where banned='Yes')
    GROUP BY t.request_at)a
INNER JOIN 
    (SELECT t.request_at as Day, count(*)as Total_requests
    FROM Trips t INNER JOIN Users u 
    ON (t.client_id=u.users_id) #OR t.driver_id=u.users_id)
    
    where t.client_id not in (select distinct users_id from Users where banned='Yes')
    and t.driver_id not in (select distinct users_id from Users where banned='Yes')
    GROUP BY t.request_at)b
USING (Day)
where Day BETWEEN '2013-10-01' AND '2013-10-03'
ORDER BY Day;

